<?xml version="1.0" encoding="utf-8"?>

<project name="medigy-persistence-tools" default="all">

    <import file="../../../support/build/module.xml"/>
    <import file="../../../graphviz/support/build/graphviz.xml"/>

    <target name="init.define-module.dependencies.main.classpath" depends="init.define-modules-artifacts-home">
        <path id="module.dependencies.main.classpath">
            <fileset dir="${common.home}/depend/lib/build" includes="*.jar"/>
            <fileset dir="${common.home}/depend/lib/main" includes="*.jar"/>

            <fileset dir="${persistence.home}/depend/lib/build" includes="*.jar"/>
            <fileset dir="${persistence.home}/depend/lib/main" includes="*.jar"/>

            <path location="${graphviz.artifacts.home}/classes/main"/>
            <path location="${hibernate-doc.artifacts.home}/classes/main"/>
            <path location="${persistence.artifacts.home}/classes/main"/>
        </path>
    </target>

    <target name="init.define-module.dependencies.test.classpath" depends="init.define-modules-artifacts-home">
        <path id="module.dependencies.test.classpath">
            <fileset dir="${common.home}/depend/lib/build" includes="*.jar"/>
            <fileset dir="${common.home}/depend/lib/main" includes="*.jar"/>
            <fileset dir="${common.home}/depend/lib/test" includes="*.jar"/>

            <fileset dir="${persistence.home}/depend/lib/build" includes="*.jar"/>
            <fileset dir="${persistence.home}/depend/lib/main" includes="*.jar"/>
            <fileset dir="${persistence.home}/depend/lib/test" includes="*.jar"/>

            <path location="${graphviz.artifacts.home}/classes/main"/>
            <path location="${hibernate-doc.artifacts.home}/classes/main"/>
            <path location="${persistence.artifacts.home}/classes/main"/>
            <path location="${persistence.artifacts.home}/classes/test"/>
        </path>
    </target>

    <target name="doc.generate-model-diagrams" depends="graphviz.init,compile.main,init.define-modules,init.define-module.dependencies.main.classpath">
        <taskdef name="diagram" classname="org.sns.tool.hibernate.document.diagram.HibernateDiagramGeneratorTask"
                                classpathref="module.dependencies.main.classpath">
            <classpath location="${module.artifacts.classes.main.home}"/>
        </taskdef>

        <property name="persistence.artifacts.doc.home" value="${persistence.artifacts.home}/doc"/>
        <property name="persistence.artifacts.doc.db.struct.home" value="${persistence.artifacts.doc.home}/db/structure"/>
        <property name="persistence.artifacts.doc.diagram.dest.file-prefix" value="${persistence.artifacts.doc.db.struct.home}/class-erd"/>
        <property name="persistence.artifacts.doc.diagram.dot.file" value="${persistence.artifacts.doc.diagram.dest.file-prefix}.dot.txt"/>

        <mkdir dir="${persistence.artifacts.doc.db.struct.home}"/>
        <diagram dotFile="${persistence.artifacts.doc.diagram.dot.file}"
                 hibernateConfigClass="com.medigy.persist.util.HibernateConfiguration"
                 hibernateConfigFile="/com/medigy/persist/hibernate.cfg.xml"
                 diagramFilterClass="com.medigy.tool.persist.hibernate.HibernateDiagramEngineerFilter"
            />

        <graphviz.dot srcFile="${persistence.artifacts.doc.diagram.dot.file}"
                      destFile="${persistence.artifacts.doc.diagram.dest.file-prefix}.svg" format="svg"/>

        <graphviz.dot srcFile="${persistence.artifacts.doc.diagram.dot.file}"
                      destFile="${persistence.artifacts.doc.diagram.dest.file-prefix}.gif" format="gif"/>
    </target>

    <target name="doc.generate-dbdd-source" depends="compile.main,init.define-modules,init.define-module.dependencies.main.classpath">
        <taskdef name="dbdg" classname="org.sns.tool.hibernate.document.dbdd.DatabaseDesignGeneratorTask"
                             classpathref="module.dependencies.main.classpath">
            <classpath location="${module.artifacts.classes.main.home}"/>
        </taskdef>

        <property name="persistence.artifacts.doc.home" value="${persistence.artifacts.home}/doc"/>
        <property name="persistence.artifacts.doc.db.dbdd.home" value="${persistence.artifacts.doc.home}/db/dbdd"/>
        <property name="persistence.artifacts.doc.db.dbdd.src" value="${persistence.artifacts.doc.db.dbdd.home}/dbdd.xml"/>

        <mkdir dir="${persistence.artifacts.doc.db.dbdd.home}"/>
        <dbdg docBookFile="${persistence.artifacts.doc.db.dbdd.src}"
              hibernateConfigClass="com.medigy.persist.util.HibernateConfiguration"
              hibernateConfigFile="/com/medigy/persist/hibernate.cfg.xml"
              structureClass="org.sns.tool.hibernate.struct.DefaultTableStructure"
              structureRulesClass="com.medigy.tool.persist.hibernate.HibernateStructureRules"
            />
    </target>

    <target name="doc.generate-dbdd-html" depends="doc.generate-dbdd-source">
        <fail message="To generate DocBook, you need DocBook XSL package from http://docbook.sourceforge.net/projects/xsl/ and then set the doc.docbook-xsl.home property." unless="doc.docbook-xsl.home"/>
        <echo message="Creating chunked HTML output in ${persistence.artifacts.doc.db.dbdd.home}"/>
        <xslt basedir="${persistence.artifacts.doc.db.dbdd.home}"
            destdir="${persistence.artifacts.doc.db.dbdd.home}"
            style="${doc.docbook-xsl.home}/html/docbook.xsl"
            force="yes" processor="trax" classpathref="module.dependencies.main.classpath">
            <include name="*.xml"/>
            <classpath location="${module.artifacts.classes.main.home}"/>
        </xslt>
    </target>

</project>