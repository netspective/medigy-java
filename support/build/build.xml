<?xml version="1.0" encoding="utf-8"?>

<project name="medigy-platform" default="all">

    <target name="init.define-properties">
        <!-- *********************************************************************************************************
             ** Remember, Ant properties are immutable once assigned. This means that any property assignments here **
             ** may be overridden by the command line or items in the build.properties file                         **
             ********************************************************************************************************* -->

        <path id="tmp.repository.home">
            <pathelement location="${basedir}/../.."/>
        </path>
        <pathconvert targetos="unix" property="repository.home" refid="tmp.repository.home"/>
        <property name="consolidated.artifacts.home" value="${basedir}/artifacts"/>
        <property name="consolidated.artifacts.doc.home" value="${consolidated.artifacts.home}/consolidated/doc"/>
        <property name="consolidated.artifacts.test.junit.home" value="${consolidated.artifacts.home}/consolidated/reports/junit"/>
        <property name="consolidated.artifacts.test.coverage.home" value="${consolidated.artifacts.home}/consolidated/reports/coverage"/>
    </target>

    <target name="clean" depends="init.define-properties">
        <delete dir="${consolidated.artifacts.home}"/>
        <delete dir="${repository.home}/support/build/ivy-cache"/>

        <ant dir="${repository.home}/graphviz/support/build" target="clean" inheritall="false" inheritrefs="false" />
        <ant dir="${repository.home}/hibernate-doc/support/build" target="clean" inheritall="false" inheritrefs="false" />
        <ant dir="${repository.home}/persistence/support/build" target="clean" inheritall="false" inheritrefs="false" />
        <ant dir="${repository.home}/persistence-tools/support/build" target="clean" inheritall="false" inheritrefs="false" />
        <ant dir="${repository.home}/service/support/build" target="clean" inheritall="false" inheritrefs="false" />
    </target>

    <target name="jar" depends="init.define-properties">
        <ant dir="${repository.home}/graphviz/support/build" target="jar" inheritall="false" inheritrefs="false">
            <property name="module.artifacts.home" value="${consolidated.artifacts.home}/graphviz"/>
        </ant>
        <ant dir="${repository.home}/hibernate-doc/support/build" target="jar" inheritall="false" inheritrefs="false">
            <property name="graphviz.artifacts.home" value="${consolidated.artifacts.home}/graphviz"/>
            <property name="module.artifacts.home" value="${consolidated.artifacts.home}/hibernate-doc"/>
        </ant>
        <ant dir="${repository.home}/persistence/support/build" target="jar" inheritall="false" inheritrefs="false">
            <property name="common.artifacts.home" value="${consolidated.artifacts.home}/common"/>
            <property name="module.artifacts.home" value="${consolidated.artifacts.home}/persistence"/>
        </ant>
        <ant dir="${repository.home}/persistence-tools/support/build" target="jar" inheritall="false" inheritrefs="false">
            <property name="graphviz.artifacts.home" value="${consolidated.artifacts.home}/graphviz"/>
            <property name="hibernate-doc.artifacts.home" value="${consolidated.artifacts.home}/hibernate-doc"/>
            <property name="persistence.artifacts.home" value="${consolidated.artifacts.home}/persistence"/>
            <property name="module.artifacts.home" value="${consolidated.artifacts.home}/persistence-tools"/>
        </ant>
        <ant dir="${repository.home}/service/support/build" target="jar" inheritall="false" inheritrefs="false">
            <property name="persistence.artifacts.home" value="${consolidated.artifacts.home}/persistence"/>
            <property name="module.artifacts.home" value="${consolidated.artifacts.home}/service"/>
        </ant>
    </target>

    <target name="test" depends="init.define-properties">
        <ant dir="${repository.home}/persistence/support/build" target="test" inheritall="false" inheritrefs="false">
            <property name="common.artifacts.home" value="${consolidated.artifacts.home}/common"/>
            <property name="module.artifacts.home" value="${consolidated.artifacts.home}/persistence"/>
        </ant>
        <ant dir="${repository.home}/service/support/build" target="test" inheritall="false" inheritrefs="false">
            <property name="persistence.artifacts.home" value="${consolidated.artifacts.home}/persistence"/>
            <property name="module.artifacts.home" value="${consolidated.artifacts.home}/service"/>
        </ant>

        <mkdir dir="${consolidated.artifacts.test.junit.home}"/>
        <junitreport todir="${consolidated.artifacts.test.junit.home}">
            <fileset dir="${consolidated.artifacts.home}">
                <include name="**/test/junit/TEST-*.xml"/>
            </fileset>
            <report format="noframes" todir="${consolidated.artifacts.test.junit.home}"/>
        </junitreport>

        <taskdef resource="emma_ant.properties">
            <classpath>
                <fileset dir="${repository.home}/common/depend/lib/test" includes="*.jar"/>
            </classpath>
        </taskdef>

        <emma>
            <report sort="+block,+name,+method,+class"
                metrics="method:70,block:80,line:80,class:100">
                <fileset dir="${consolidated.artifacts.home}" includes="**/*.emma"/>

                <sourcepath>
                    <dirset dir="${repository.home}" >
                        <include name="**/src/java/main" />
                        <include name="**/src/java/test" />
                    </dirset>
                </sourcepath>

                <txt outfile="${consolidated.artifacts.test.coverage.home}/coverage.txt" depth="package"
                    columns="class,method,block,line,name"/>
                <html outfile="${consolidated.artifacts.test.coverage.home}/index.html" depth="method"
                    columns="name,class,method,block,line"/>
            </report>
        </emma>
    </target>

    <target name="doc.javadoc.std" depends="init.define-properties">
        <property name="artifacts.javadoc.home" value="${consolidated.artifacts.doc.home}/javadoc"/>
        <delete dir="${artifacts.javadoc.home}"/>
        <mkdir dir="${artifacts.javadoc.home}"/>
        <javadoc packagenames="com.medigy.*"
            destdir="${artifacts.javadoc.home}"
            author="true"
            version="true"
            use="true"
            windowtitle="Medigy Platform Documentation"
            doctitle="Medigy Platform Documentation"
            bottom="Copyright &#169; 2005 Netspective. All Rights Reserved.">

            <sourcepath>
                <dirset dir="${repository.home}" >
                    <include name="**/src/java/main" />
                </dirset>
            </sourcepath>            

            <classpath>
                <fileset dir="${repository.home}" >
                    <include name="**/depend/lib/build/*.jar" />
                    <include name="**/depend/lib/main/*.jar" />
                </fileset>
            </classpath>
        </javadoc>
    </target>

    <target name="doc" depends="init.define-properties,doc.javadoc.std">
        <ant dir="${repository.home}/persistence-tools/support/build" target="doc.generate-model-diagrams" inheritall="false" inheritrefs="false">
            <property name="graphviz.artifacts.home" value="${consolidated.artifacts.home}/graphviz"/>
            <property name="hibernate-doc.artifacts.home" value="${consolidated.artifacts.home}/hibernate-doc"/>
            <property name="persistence.artifacts.home" value="${consolidated.artifacts.home}/persistence"/>
            <property name="module.artifacts.home" value="${consolidated.artifacts.home}/persistence-tools"/>
        </ant>
    </target>

    <target name="all" depends="clean,jar"/>
</project>